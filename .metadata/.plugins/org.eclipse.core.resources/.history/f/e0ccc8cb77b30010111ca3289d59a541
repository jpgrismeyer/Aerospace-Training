/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>
#include <stdbool.h>

#include "stm32l47xx.h"
#include "stm32l475xx_gpio_driver.h"
#include "stm32l47xx_i2c_driver.h"

/* Ajustes a confirmar:
   - PB14 es el LED user.
*/
#define LED_GPIO_PORT   GPIOB
#define LED_PIN         14

static void delay_busy(volatile uint32_t ticks)
{
    while (ticks--) {
        __asm__("nop");
    }
}

static void LED_Init_User(void)
{
    GPIO_Handle_t LedHandle;

    LedHandle.pGPIOx = LED_GPIO_PORT;
    LedHandle.GPIO_PinConfig.GPIO_PinNumber      = LED_PIN;
    LedHandle.GPIO_PinConfig.GPIO_PinMode        = GPIO_MODE_OUT;      // salida
    LedHandle.GPIO_PinConfig.GPIO_PinSpeed       = GPIO_SPEED_LOW;     // low speed
    LedHandle.GPIO_PinConfig.GPIO_PinPuPdControl = GPIO_NO_PUPD;       // sin pull
    LedHandle.GPIO_PinConfig.GPIO_PinOPType      = GPIO_OP_TYPE_PP;    // push-pull
    LedHandle.GPIO_PinConfig.GPIO_PinAltFunMode  = 0;                  // no AF

    GPIO_Init(&LedHandle);
}

static void LED_Blink(uint32_t delayTicks, uint32_t times)
{
    for (uint32_t i = 0; i < times; i++) {
        GPIO_ToggleOutputPin(LED_GPIO_PORT, LED_PIN);
        delay_busy(delayTicks);
        GPIO_ToggleOutputPin(LED_GPIO_PORT, LED_PIN);
        delay_busy(delayTicks);
    }
}

int main(void)
{
    // 1. init LED
    LED_Init_User();

    // 2. blink rápido 3 veces -> "arranqué, estoy vivo antes de I2C"
    LED_Blink(50000, 3);

    // 3. preparar handle I2C2 y llamar I2C_Init()
    I2C_Handle_t I2C2Handle;
    I2C2Handle.pI2Cx = I2C2;

    I2C_Init(&I2C2Handle);

    // Si llegamos acá, I2C_Init() NO colgó.
    // 4. loop infinito con blink LENTO = ok I2C init
    while (1) {
        GPIO_ToggleOutputPin(LED_GPIO_PORT, LED_PIN);
        delay_busy(300000);
    }
}
