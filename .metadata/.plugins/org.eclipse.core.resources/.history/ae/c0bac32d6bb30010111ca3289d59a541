/**
 ******************************************************************************
 * @file           : main.c
 * @author         : Auto-generated by STM32CubeIDE
 * @brief          : Main program body
 ******************************************************************************
 * @attention
 *
 * Copyright (c) 2025 STMicroelectronics.
 * All rights reserved.
 *
 * This software is licensed under terms that can be found in the LICENSE file
 * in the root directory of this software component.
 * If no LICENSE file comes with this software, it is provided AS-IS.
 *
 ******************************************************************************
 */

#include <stdint.h>
#include <stdbool.h>

#include "stm32l47xx_i2c_driver.h"
#include "hts221.h"

/* ---- LED driver bare metal PB14 (como veníamos usando) ---- */

#define PERIPH_BASE        0x40000000UL
#define AHB2PERIPH_BASE    (PERIPH_BASE + 0x08000000UL)
#define RCC_BASE           0x40021000UL
#define GPIOB_BASE         (AHB2PERIPH_BASE + 0x0400UL)

#define RCC_AHB2ENR        (*(volatile uint32_t *)(RCC_BASE + 0x4C))
#define GPIOB_MODER        (*(volatile uint32_t *)(GPIOB_BASE + 0x00))
#define GPIOB_ODR          (*(volatile uint32_t *)(GPIOB_BASE + 0x14))

#define LED_PIN 14

static void LED_Init(void)
{
    /* enable clock for GPIOB */
    RCC_AHB2ENR |= (1u << 1);

    /* PB14 output mode */
    GPIOB_MODER &= ~(3u << (LED_PIN * 2));
    GPIOB_MODER |=  (1u << (LED_PIN * 2));
}

static void LED_Toggle(void)
{
    GPIOB_ODR ^= (1u << LED_PIN);
}

static void delay_busy(volatile uint32_t ticks)
{
    while (ticks--) {
        _asm_("nop");
    }
}

/* ----------------------------------------------------------- */

int main(void)
{
    LED_Init();

    /* Inicializamos el sensor HTS221 (esto inicializa I2C2 adentro) */
    bool ok = HTS221_Init();

    if (!ok)
    {
        // Error: sensor no responde. Blink rápido forever
        while (1) {
            LED_Toggle();
            delay_busy(50000); // rápido
        }
    }

    // Si ok == true:
    // Loop principal:
    // - leer temperatura
    // - si supera el umbral, blink rápido, si no, blink lento
    const float TEMP_HIGH_THRESHOLD_C = 28.0f;

    while (1)
    {
        float tC = HTS221_ReadTemperatureC();

        if (tC >= TEMP_HIGH_THRESHOLD_C) {
            LED_Toggle();
            delay_busy(50000);   // rápido
        } else {
            LED_Toggle();
            delay_busy(300000);  // lento
        }
    }
}
